# Serial Peripheral Interface (SPI) Library

### Introduction
The Serial Peripheral Interface (SPI) allows high-speed (device dependent, Atmega328 can generate CLK signal at half of the frequency of the CPU clock) synchronous data transfer between the device and peripheral units, or between several AVR devices. Generally, a SPI compatible device can be configured into either master or slave mode, with the former allowing for transmitting data and the later allowing for receiving data.

This library provides basic functions for SPI communications with specialized devices while it has already contained specialized functions for communicating with 25LC256 256K SPI Bus Serial EEPROM.

### SPI Operations
There are four essential connections for SPI devices. They are MISO(Master In Slave Out), MOSI(Master Out Slave In), Clock(CLK), and SS(active low Slave Select). SPI devices are able to operate in either master or slave mode. The basic operation of the SPI protocol is based on [shift register](https://en.wikipedia.org/wiki/Shift_register). Whereas the master is ready to write a byte to the slave device, a (trivial) byte would be sent back to the master by the slave. By the same token, a master's request of data from a slave device involves the master sending a (trivial) byte to the slave to trade back a byte of information. The slave device the master device is communicating to is the one whose Slave Select is pulled to LOW. The bits will be shifted on every clock edge generated by the master device.

### How to use the library
```
void initSPI_master(uint8_t mode, uint8_t prescaler);
```
`uint8_t mode` allows for values between 0 and 3. For both Mode 0 and 1, the SCK is low when idle, but Mode 0 samples at the leading clock edge while Mode 1 samples at the trailing clock edge. For both Mode 2 and 3, the SCK is high when idle, but Mode 2 samples at the leading clock edge while Mode 3 samples at the trailing clock edge. The mode to use would depend on the device you are communicating with over SPI. The most significant bit is transmitted first.

`uint8_t prescaler` specifies the prescaler to divide the CPU clock frequency by to obtain th SPI clock frequency. Possible prescalers include: 2, 4, 6, 8, 16, 32, 64, 128.

```
void initSPI_slave(uint8_t mode);
```
`uint8_t mode` allows for values between 0 and 3. For both Mode 0 and 1, the SCK is low when idle, but Mode 0 samples at the leading clock edge while Mode 1 samples at the trailing clock edge. For both Mode 2 and 3, the SCK is high when idle, but Mode 2 samples at the leading clock edge while Mode 3 samples at the trailing clock edge. The mode to use would depend on the device you are communicating with over SPI. The most significant bit is transmitted first.


```
void SPI_tradeByte(uint8_t byte);
```
`uint8_t byte` is the byte of information to be transmitted over SPI. It could zero when you want to request certain information from a slave device. This function blocks until all eight bits have been shifted/received.

Sample Code: Storing Data in EEPROM over SPI
```
#define F_CPU (8000000UL)

#include <avr/io.h>
#include <util/delay.h>
#include <avr/power.h>
#include "USART.h"
#include "SPI_with_EEPROM.h"

int main(){
  //Set the mcu to run at 8 MHz with the internal oscillator
  clock_prescale_set(clock_div_1);
  Serial_init();
  initSPI(0, 128);

  char character;
  EEPROM_writeSingleByte(0x0, (uint8_t)"");
  uint16_t test_address = 0x1;
  const char* myString = "Fulfill your destiny!\n";
  EEPROM_clearAll();
  for(;;){
    while(1){
      if(Serial_available()){
        character = Serial_receiveByte();
        break;
      }
    }

    EEPROM_writeSingleByte(test_address, (uint8_t)character);
    Serial_transmitByte((uint8_t)character);
    EEPROM_writeString(test_address, myString);
    EEPROM_readStringToSerial((uint16_t)0x1, (uint16_t) 25);
    Serial_transmitByte(EEPROM_readByte(test_address));
    test_address++;
  }

  return 0;
}
```

Source: [Atmega328P datasheet](http://ww1.microchip.com/downloads/en/DeviceDoc/ATmega328_P%20AVR%20MCU%20with%20picoPower%20Technology%20Data%20Sheet%2040001984A.pdf)
